// Scamnemesis Prisma Schema
// Fraud Reporting System Database

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector"), pg_trgm]
}

// ==================== ENUMS ====================

enum UserRole {
  BASIC
  STANDARD
  GOLD
  ADMIN
  SUPER_ADMIN
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  MERGED
  ARCHIVED
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudType {
  ROMANCE_SCAM
  INVESTMENT_FRAUD
  PHISHING
  IDENTITY_THEFT
  ONLINE_SHOPPING_FRAUD
  TECH_SUPPORT_SCAM
  LOTTERY_PRIZE_SCAM
  EMPLOYMENT_SCAM
  RENTAL_SCAM
  CRYPTOCURRENCY_SCAM
  PYRAMID_MLM_SCHEME
  INSURANCE_FRAUD
  CREDIT_CARD_FRAUD
  WIRE_FRAUD
  MONEY_MULE
  ADVANCE_FEE_FRAUD
  BUSINESS_EMAIL_COMPROMISE
  SOCIAL_ENGINEERING
  FAKE_CHARITY
  GOVERNMENT_IMPERSONATION
  UTILITY_SCAM
  GRANDPARENT_SCAM
  SEXTORTION
  RANSOMWARE
  ACCOUNT_TAKEOVER
  SIM_SWAPPING
  CATFISHING
  PONZI_SCHEME
  OTHER
}

enum EvidenceType {
  IMAGE
  DOCUMENT
  VIDEO
  AUDIO
  PAYMENT_EVIDENCE
  FRAUDSTER_PHOTO
  SCREENSHOT
  DAMAGE_DOCS
  CRIME_SCENE
  OTHER
}

enum Blockchain {
  BITCOIN
  ETHEREUM
  TRON
  SOLANA
  BINANCE_SMART_CHAIN
  POLYGON
  CARDANO
  RIPPLE
  LITECOIN
  POLKADOT
  OTHER
}

enum PerpetratorType {
  INDIVIDUAL
  COMPANY
  UNKNOWN
}

enum CommentStatus {
  PENDING_MODERATION
  APPROVED
  REJECTED
}

enum DuplicateClusterStatus {
  PENDING
  RESOLVED
  IGNORED
}

enum EnrichmentEventType {
  CRAWL_RESULT
  SANCTIONS_MATCH
  NEWS_MATCH
}

enum EnrichmentStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

// ==================== USERS & AUTH ====================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String?
  role            UserRole  @default(BASIC)
  isActive        Boolean   @default(true) @map("is_active")
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Display name
  displayName     String?         @map("display_name")

  // Relations
  apiKeys          ApiKey[]
  reports          Report[]        @relation("ReporterReports")
  moderatedReports Report[]        @relation("ModeratedByUser")
  comments         Comment[]
  moderatedComments Comment[]      @relation("ModeratedComments")
  auditLogs        AuditLog[]
  refreshTokens    RefreshToken[]

  // Admin Relations
  resolvedClusters DuplicateCluster[]

  // CMS Relations
  media            Media[]
  pages            Page[]
  pageRevisions    PageRevision[]
  systemSettings   SystemSetting[]

  // Enrichment Relations
  reviewedEnrichments Enrichment[]

  @@map("users")
}

model ApiKey {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  key         String    @unique
  name        String
  scopes      String[]  @default([])
  rateLimit   Int       @default(1000) @map("rate_limit")
  isActive    Boolean   @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])              // Added: for user API key queries
  @@index([isActive, expiresAt]) // Added: for active key lookups
  @@map("api_keys")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])              // Added: for ban operations (deleteMany by userId)
  @@index([expiresAt])           // Added: for expired token cleanup
  @@map("refresh_tokens")
}

// ==================== REPORTS ====================

model Report {
  id              String       @id @default(uuid())
  status          ReportStatus @default(PENDING)
  severity        Severity?
  publicId        String       @unique @default(uuid()) @map("public_id")

  // Incident
  fraudType             FraudType    @map("fraud_type")
  incidentDate          DateTime?    @map("incident_date")
  transactionDate       DateTime?    @map("transaction_date")
  summary               String
  description           String?      @db.Text
  financialLossAmount   Decimal?     @map("financial_loss_amount") @db.Decimal(15, 2)
  financialLossCurrency String       @default("EUR") @map("financial_loss_currency")
  location              Json?

  // Location (legacy - use location JSON field)
  locationStreet     String? @map("location_street")
  locationCity       String? @map("location_city")
  locationPostalCode String? @map("location_postal_code")
  locationCountry    String? @map("location_country")

  // Reporter
  reporterId      String    @map("reporter_id")
  reporterEmail   String    @map("reporter_email")
  reporterName    String?   @map("reporter_name")
  reporterPhone   String?   @map("reporter_phone")
  reporterConsent Boolean   @default(true) @map("reporter_consent")
  reporterLang    String    @default("en") @map("reporter_lang")

  // Consent fields
  wantUpdates     Boolean   @default(false) @map("want_updates")
  agreeToTerms    Boolean   @default(false) @map("agree_to_terms")
  agreeToGDPR     Boolean   @default(false) @map("agree_to_gdpr")

  // Admin / Moderation
  moderatedById    String?   @map("moderated_by_id")
  moderatedAt      DateTime? @map("moderated_at")
  publishedAt      DateTime? @map("published_at")
  rejectionReason  String?   @map("rejection_reason") @db.Text
  adminNotes       String?   @map("admin_notes") @db.Text
  maskingOverrides Json?     @map("masking_overrides")
  metadata         Json?

  // Merge tracking
  mergedIntoId String?  @map("merged_into_id")
  mergeCount   Int      @default(0) @map("merge_count")

  // View tracking
  viewCount    Int      @default(0) @map("view_count")

  // Case tracking for reporters
  trackingToken String?  @unique @map("tracking_token")
  caseNumber    String?  @unique @map("case_number")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  reporter          User               @relation("ReporterReports", fields: [reporterId], references: [id], onDelete: Restrict)
  moderatedBy       User?              @relation("ModeratedByUser", fields: [moderatedById], references: [id], onDelete: SetNull)
  mergedInto        Report?            @relation("MergedReports", fields: [mergedIntoId], references: [id], onDelete: SetNull)
  mergedReports     Report[]           @relation("MergedReports")
  perpetrators      Perpetrator[]
  digitalFootprint  DigitalFootprint?
  financialInfo     FinancialInfo?
  cryptoInfo        CryptoInfo?
  companyInfo       CompanyInfo?
  vehicleInfo       VehicleInfo?
  evidence          Evidence[]
  comments          Comment[]
  duplicateClusters DuplicateClusterReport[]
  views             ReportView[]

  @@index([status])
  @@index([severity])
  @@index([fraudType])
  @@index([locationCountry])
  @@index([createdAt])
  @@index([mergedIntoId])
  @@index([reporterId])           // Added: for "my reports" queries
  @@index([moderatedById])        // Added: for admin moderation queries
  @@index([status, createdAt])    // Added: composite for filtered listings
  @@map("reports")
}

model Perpetrator {
  id                  String          @id @default(uuid())
  reportId            String          @map("report_id")
  perpetratorType     PerpetratorType @default(INDIVIDUAL) @map("perpetrator_type")

  fullName            String? @map("full_name")
  fullNameNormalized  String? @map("full_name_normalized")
  nickname            String?
  username            String?
  approxAge           Int?    @map("approx_age")
  nationality         String?
  physicalDescription String? @map("physical_description") @db.Text
  phone               String?
  phoneNormalized     String? @map("phone_normalized")
  email               String?
  emailNormalized     String? @map("email_normalized")

  // Address
  addressStreet     String? @map("address_street")
  addressCity       String? @map("address_city")
  addressPostalCode String? @map("address_postal_code")
  addressCountry    String? @map("address_country")

  // Enrichment data from external sources
  enrichedData      Json?   @map("enriched_data")

  // Embeddings for similarity search
  nameEmbedding     Unsupported("vector(384)")? @map("name_embedding")

  // One-to-many relation: one perpetrator belongs to one report
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Enrichment data linked to this perpetrator
  enrichments Enrichment[]

  @@index([reportId])
  @@index([phoneNormalized])
  @@index([emailNormalized])
  @@index([fullNameNormalized])
  @@map("perpetrators")
}

model DigitalFootprint {
  id       String @id @default(uuid())
  reportId String @unique @map("report_id")

  telegram            String?
  whatsapp            String?
  signal              String?
  instagram           String?
  facebook            String?
  tiktok              String?
  twitter             String?
  websiteUrl          String?  @map("website_url")
  domainName          String?  @map("domain_name")
  domainCreationDate  DateTime? @map("domain_creation_date")
  ipAddress           String?  @map("ip_address")
  ipCountry           String?  @map("ip_country")
  isp                 String?
  ipAbuseScore        Int?     @map("ip_abuse_score")

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([domainName])
  @@index([ipAddress])
  @@map("digital_footprints")
}

model FinancialInfo {
  id       String @id @default(uuid())
  reportId String @unique @map("report_id")

  iban                String?
  ibanNormalized      String? @map("iban_normalized")
  accountHolder       String? @map("account_holder")
  accountNumber       String? @map("account_number")
  bankName            String? @map("bank_name")
  bankCountry         String? @map("bank_country")
  swiftBic            String? @map("swift_bic")
  routingNumber       String? @map("routing_number")
  bsb                 String?
  sortCode            String? @map("sort_code")
  ifsc                String?
  cnaps               String?
  otherBankingDetails String? @map("other_banking_details") @db.Text

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([ibanNormalized])
  @@index([accountNumber])
  @@map("financial_info")
}

model CryptoInfo {
  id       String @id @default(uuid())
  reportId String @unique @map("report_id")

  walletAddress      String?     @map("wallet_address")
  walletNormalized   String?     @map("wallet_normalized")
  blockchain         Blockchain?
  exchangeWalletName String?     @map("exchange_wallet_name")
  transactionHash    String?     @map("transaction_hash")
  paypalAccount      String?     @map("paypal_account")

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([walletNormalized])
  @@map("crypto_info")
}

model CompanyInfo {
  id       String @id @default(uuid())
  reportId String @unique @map("report_id")

  name            String?
  vatTaxId        String? @map("vat_tax_id")
  addressStreet   String? @map("address_street")
  addressCity     String? @map("address_city")
  addressPostal   String? @map("address_postal")
  addressCountry  String? @map("address_country")

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([vatTaxId])
  @@map("company_info")
}

model VehicleInfo {
  id       String @id @default(uuid())
  reportId String @unique @map("report_id")

  make            String?
  model           String?
  color           String?
  licensePlate    String? @map("license_plate")
  vin             String?
  registeredOwner String? @map("registered_owner")

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([licensePlate])
  @@index([vin])
  @@map("vehicle_info")
}

model Evidence {
  id          String       @id @default(uuid())
  reportId    String       @map("report_id")
  type        EvidenceType
  fileKey     String?      @map("file_key")
  url         String?
  externalUrl String?      @map("external_url")
  description String?
  mimeType    String?      @map("mime_type")
  fileSize    Int?         @map("file_size")
  hash        String?

  // Image processing
  thumbnailKey String? @map("thumbnail_key")
  thumbnailUrl String? @map("thumbnail_url")
  pHash        String? @map("p_hash")
  hasFace      Boolean @default(false) @map("has_face")
  faceCount    Int?    @map("face_count")

  // OCR
  ocrText       String? @map("ocr_text") @db.Text
  ocrConfidence Float?  @map("ocr_confidence")

  createdAt DateTime @default(now()) @map("created_at")

  report    Report      @relation(fields: [reportId], references: [id], onDelete: Cascade)
  faces     FaceData[]

  @@index([reportId])  // Added: critical FK index for evidence queries
  @@index([pHash])
  @@index([hash])
  @@map("evidence")
}

model FaceData {
  id         String @id @default(uuid())
  evidenceId String @map("evidence_id")

  boundingBox Json      @map("bounding_box")
  embedding   Unsupported("vector(512)")? @map("embedding")
  quality     Float?
  cropKey     String?   @map("crop_key")

  evidence Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)

  @@index([evidenceId])         // Added: for face retrieval by evidence
  @@map("face_data")
}

// ==================== COMMENTS ====================

model Comment {
  id              String        @id @default(uuid())
  reportId        String        @map("report_id")
  userId          String        @map("user_id")
  content         String        @db.Text
  status          CommentStatus @default(PENDING_MODERATION)
  moderatedAt     DateTime?     @map("moderated_at")
  moderatedById   String?       @map("moderated_by_id")
  rejectionReason String?       @map("rejection_reason")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Reporting system
  isReported      Boolean       @default(false) @map("is_reported")
  reportReason    String?       @map("report_reason")
  reportedAt      DateTime?     @map("reported_at")

  // Voting system
  upvotes         Int           @default(0)

  report      Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  moderatedBy User?  @relation("ModeratedComments", fields: [moderatedById], references: [id], onDelete: SetNull)

  @@index([reportId])
  @@index([status])
  @@index([userId])              // Added: for user comment history
  @@index([moderatedById])       // Added: for moderator queries
  @@index([reportId, status])   // Added: composite for report comments
  @@index([isReported])         // Added: for reported comment filtering
  @@map("comments")
}

// ==================== DUPLICATE DETECTION ====================

model DuplicateCluster {
  id               String                 @id @default(uuid())
  primaryReportId  String?                @map("primary_report_id")
  status           DuplicateClusterStatus @default(PENDING)
  confidence       Float                  @default(0)
  matchType        String?                @map("match_type")
  matchingCriteria Json?                  @map("matching_criteria")
  resolvedAt       DateTime?              @map("resolved_at")
  resolvedById     String?                @map("resolved_by_id")
  createdAt        DateTime               @default(now()) @map("created_at")

  reports    DuplicateClusterReport[]
  resolvedBy User?                        @relation(fields: [resolvedById], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([confidence])
  @@index([resolvedById])        // Added: for admin resolution queries
  @@index([primaryReportId])     // Added: for primary report lookups
  @@map("duplicate_clusters")
}

model DuplicateClusterReport {
  clusterId String @map("cluster_id")
  reportId  String @map("report_id")
  similarity Float
  isPrimary Boolean @default(false) @map("is_primary")

  cluster DuplicateCluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)
  report  Report           @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@id([clusterId, reportId])
  @@map("duplicate_cluster_reports")
}

// ==================== ENRICHMENT ====================

model Enrichment {
  id            String              @id @default(uuid())
  perpetratorId String?             @map("perpetrator_id")
  eventType     EnrichmentEventType @map("event_type")
  sourceId      String              @map("source_id")
  matchType     String              @map("match_type")
  matchValue    String              @map("match_value")
  similarity    Float?
  data          Json
  status        EnrichmentStatus    @default(PENDING)
  reviewedAt    DateTime?           @map("reviewed_at")
  reviewedById  String?             @map("reviewed_by_id")
  createdAt     DateTime            @default(now()) @map("created_at")

  // Relations
  perpetrator   Perpetrator?        @relation(fields: [perpetratorId], references: [id], onDelete: SetNull)
  reviewedBy    User?               @relation(fields: [reviewedById], references: [id], onDelete: SetNull)

  @@index([perpetratorId])
  @@index([status])
  @@index([reviewedById])
  @@index([eventType])
  @@map("enrichments")
}

// ==================== CRAWLER DATA ====================

model CrawlResult {
  id            String    @id @default(uuid())
  sourceId      String    @map("source_id")
  url           String?
  urlCanonical  String?   @map("url_canonical")
  title         String?
  content       String?   @db.Text
  language      String?   @db.VarChar(10)
  publishedAt   DateTime? @map("published_at")
  contentHash   String    @unique @map("content_hash")
  entities      Json?     @default("[]")
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([sourceId])
  @@index([publishedAt])
  @@index([urlCanonical])
  @@map("crawl_results")
}

model SanctionEntry {
  id              String    @id @default(uuid())
  sourceId        String    @map("source_id")
  externalId      String    @map("external_id")
  entryType       String    @map("entry_type")
  names           String[]
  aliases         String[]  @default([])
  dateOfBirth     DateTime? @map("date_of_birth") @db.Date
  nationalities   String[]  @default([])
  addresses       Json?     @default("[]")
  identifications Json?     @default("[]")
  programs        String[]  @default([])
  remarks         String?   @db.Text
  rawData         Json?     @map("raw_data")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([sourceId, externalId])
  @@index([sourceId])
  @@index([entryType])
  @@map("sanctions_entries")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  changes    Json?
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== VIEW TRACKING ====================

model ReportView {
  id        String   @id @default(uuid())
  reportId  String   @map("report_id")
  ipHash    String   @map("ip_hash")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([reportId, ipHash])
  @@index([reportId])
  @@index([createdAt])
  @@map("report_views")
}

// ==================== SEARCH INDEX ====================

model SearchIndex {
  id            String   @id @default(uuid())
  reportId      String   @unique @map("report_id")
  searchText    String   @map("search_text") @db.Text
  lastIndexedAt DateTime @default(now()) @map("last_indexed_at")

  @@map("search_index")
}

// ==================== RATE LIMITING ====================

model RateLimit {
  id         String   @id @default(uuid())
  identifier String   @unique
  count      Int      @default(0)
  windowStart DateTime @map("window_start")
  expiresAt  DateTime @map("expires_at")

  @@index([expiresAt])
  @@map("rate_limits")
}

// ==================== CMS - MEDIA LIBRARY ====================

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
  OTHER
}

enum MediaStatus {
  PROCESSING
  READY
  FAILED
  DELETED
  QUARANTINED
}

model Media {
  id          String      @id @default(uuid())
  type        MediaType   @default(IMAGE)
  status      MediaStatus @default(PROCESSING)

  // File info
  filename       String
  originalName   String      @map("original_name")
  mimeType       String      @map("mime_type")
  fileSize       Int         @map("file_size")

  // S3/MinIO keys
  fileKey        String      @map("file_key")
  thumbnailKey   String?     @map("thumbnail_key")

  // URLs (presigned or CDN)
  url            String?
  thumbnailUrl   String?     @map("thumbnail_url")

  // Image dimensions
  width          Int?
  height         Int?

  // Metadata
  title          String?
  altText        String?     @map("alt_text")
  caption        String?     @db.Text
  description    String?     @db.Text

  // Hash for deduplication
  hash           String?
  pHash          String?     @map("p_hash")

  // Virus scan
  scanStatus     String?     @map("scan_status")
  scanResult     String?     @map("scan_result")
  scannedAt      DateTime?   @map("scanned_at")

  // Ownership
  uploadedById   String      @map("uploaded_by_id")

  // Soft delete
  deletedAt      DateTime?   @map("deleted_at")

  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  uploadedBy     User        @relation(fields: [uploadedById], references: [id], onDelete: Restrict)
  pageMedia      PageMedia[]

  @@index([type])
  @@index([status])
  @@index([hash])
  @@index([uploadedById])
  @@index([deletedAt])
  @@map("media")
}

// ==================== CMS - SEO ====================

model SeoMeta {
  id              String    @id @default(uuid())

  // Target entity (polymorphic)
  entityType      String    @map("entity_type")  // 'page', 'report', 'home'
  entityId        String?   @map("entity_id")

  // Basic SEO
  title           String?   @db.VarChar(70)
  description     String?   @db.VarChar(160)
  keywords        String[]

  // Open Graph
  ogTitle         String?   @map("og_title")
  ogDescription   String?   @map("og_description") @db.Text
  ogImage         String?   @map("og_image")
  ogType          String?   @map("og_type") @default("website")

  // Twitter
  twitterTitle    String?   @map("twitter_title")
  twitterDescription String? @map("twitter_description") @db.Text
  twitterImage    String?   @map("twitter_image")
  twitterCard     String?   @map("twitter_card") @default("summary_large_image")

  // Indexing
  noIndex         Boolean   @default(false) @map("no_index")
  noFollow        Boolean   @default(false) @map("no_follow")
  canonicalUrl    String?   @map("canonical_url")

  // Schema.org JSON-LD
  schemaMarkup    Json?     @map("schema_markup")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([entityType, entityId])
  @@index([entityType])
  @@map("seo_meta")
}

model SeoRedirect {
  id          String    @id @default(uuid())

  fromPath    String    @unique @map("from_path")
  toPath      String    @map("to_path")
  statusCode  Int       @default(301) @map("status_code")  // 301, 302, 307, 308
  isActive    Boolean   @default(true) @map("is_active")

  // Analytics
  hitCount    Int       @default(0) @map("hit_count")
  lastHitAt   DateTime? @map("last_hit_at")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("seo_redirects")
}

// ==================== CMS - PAGES ====================

enum PageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Page {
  id          String      @id @default(uuid())

  // URL and identification
  slug        String      @unique
  path        String      @unique  // full path like /about/team

  // Content
  title       String
  content     String      @db.Text
  excerpt     String?     @db.Text

  // Status
  status      PageStatus  @default(DRAFT)
  publishedAt DateTime?   @map("published_at")

  // Hierarchy
  parentId    String?     @map("parent_id")
  sortOrder   Int         @default(0) @map("sort_order")

  // Template
  template    String      @default("default")

  // Featured image
  featuredImageId String? @map("featured_image_id")

  // Author
  authorId    String      @map("author_id")

  // Metadata
  metadata    Json?

  // Soft delete
  deletedAt   DateTime?   @map("deleted_at")

  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  parent      Page?       @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Page[]      @relation("PageHierarchy")
  author      User        @relation(fields: [authorId], references: [id], onDelete: Restrict)
  revisions   PageRevision[]
  pageMedia   PageMedia[]

  @@index([status])
  @@index([parentId])
  @@index([deletedAt])
  @@index([authorId])            // Added: for author page queries
  @@index([status, publishedAt]) // Added: for published pages listing
  @@index([featuredImageId])     // Added: for featured image lookups
  @@map("pages")
}

model PageRevision {
  id          String    @id @default(uuid())
  pageId      String    @map("page_id")

  // Snapshot
  title       String
  content     String    @db.Text
  excerpt     String?   @db.Text

  // Version info
  version     Int

  // Author
  authorId    String    @map("author_id")

  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  page        Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([pageId])
  @@index([version])
  @@index([authorId])
  @@map("page_revisions")
}

model PageMedia {
  id        String @id @default(uuid())
  pageId    String @map("page_id")
  mediaId   String @map("media_id")
  sortOrder Int    @default(0) @map("sort_order")

  page      Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  media     Media  @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([pageId, mediaId])
  @@index([mediaId])  // Added: for reverse lookups (media usage)
  @@map("page_media")
}

// ==================== CMS - SYSTEM SETTINGS ====================

model SystemSetting {
  id          String    @id @default(uuid())

  key         String    @unique
  value       Json
  type        String    @default("string")  // string, number, boolean, json
  group       String    @default("general")

  label       String?
  description String?   @db.Text

  isPublic    Boolean   @default(false) @map("is_public")

  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedById String?   @map("updated_by_id")

  updatedBy   User?     @relation(fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([group])
  @@index([isPublic])
  @@index([updatedById])  // Added: for tracking who updated settings
  @@map("system_settings")
}
